<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi App</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body style="text-align: center; font-family: sans-serif; padding-top: 100px;">

    <div id="main-container">
        <h2 id="status">Waiting for Pi Browser...</h2>
        <div id="payment-box" style="display: none;">
            <button id="pay-button" style="padding: 20px; background: purple; color: white; border-radius: 10px;">
                PAY 2.6 PI
            </button>
        </div>
    </div>

    <script>
        const statusStatus = document.getElementById('status');
        const payBtn = document.getElementById('pay-button');

        // ننتظر ثانية واحدة للتأكد من أن المتصفح جاهز
        setTimeout(() => {
            if (typeof Pi !== 'undefined') {
                Pi.init({ version: "2.0", sandbox: true });
                authenticate();
            } else {
                statusStatus.innerText = "Error: Pi SDK not loaded!";
            }
        }, 1000);

        async function authenticate() {
            try {
                const auth = await Pi.authenticate(['payments', 'username'], onIncompletePayment);
                statusStatus.innerText = "Hello " + auth.user.username;
                document.getElementById('payment-box').style.display = "block";
            } catch (err) {
                statusStatus.innerText = "Auth Error: " + err.message;
            }
        }

        async function onIncompletePayment(payment) { /* Handle if needed */ }

        payBtn.onclick = async () => {
            try {
                await Pi.createPayment({
                    amount: 2.6,
                    memo: "Test",
                    metadata: { id: "123" }
                }, {
                    onReadyForServerApproval: (id) => fetch('/api/approve', {
                        method: 'POST',
                        body: JSON.stringify({ paymentId: id })
                    }),
                    onReadyForServerCompletion: (id, txid) => fetch('/api/complete', {
                        method: 'POST',
                        body: JSON.stringify({ paymentId: id, txid: txid })
                    }),
                    onCancel: () => alert("Cancelled"),
                    onError: (err) => alert(err.message)
                });
            } catch (e) { console.error(e); }
        };
    </script>
</body>
</html>
