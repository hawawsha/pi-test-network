<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Payment Store</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body style="text-align: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding-top: 50px;">

    <div style="max-width: 380px; margin: auto; background: white; padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.15);">
        <h2 style="color: #673ab7; margin-bottom: 10px;">ูุชุฌุฑ Pi ุงูุชุฌุฑูุจู</h2>
        <div id="status-container" style="margin-bottom: 20px;">
            <p id="status" style="color: #efa929; font-weight: bold;">๐ ุฌุงุฑู ูุญุต ุงูุงุชุตุงู ุจู Pi...</p>
        </div>
        
        <div id="payment-box" style="display: none; border-top: 2px solid #eee; pt-20px">
            <p style="font-size: 1.2rem; color: #333;">ูููุฉ ุงูุทูุจ</p>
            <p style="font-size: 2.5rem; font-weight: bold; color: #673ab7; margin: 10px 0;">2.6 Pi</p>
            <button id="btn-pay" style="width: 100%; padding: 18px; background-color: #673ab7; color: white; border: none; border-radius: 15px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s;">
                ุฏูุน ุงูุขู (Testnet)
            </button>
        </div>
    </div>

    <script>
        const statusText = document.getElementById('status');
        const paymentBox = document.getElementById('payment-box');
        const payBtn = document.getElementById('btn-pay');

        // ุจุฏุก ุชุดุบูู ุงูุชุทุจูู ููุฑ ุชุญููู ุงูููุชุจุฉ
        function initPi() {
            if (typeof Pi !== 'undefined') {
                try {
                    Pi.init({ version: "2.0", sandbox: true });
                    console.log("Pi SDK Initialized");
                    authenticateUser();
                } catch (e) {
                    statusText.innerText = "ุฎุทุฃ ูู ุชููุฆุฉ ุงูููุชุจุฉ";
                }
            } else {
                statusText.innerText = "ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุจุฉ Pi";
            }
        }

        async function authenticateUser() {
            try {
                // ุทูุจ ุชุณุฌูู ุงูุฏุฎูู (ูุน ุชุญุฏูุฏ ุงูุตูุงุญูุงุช ุงููุทููุจุฉ)
                const auth = await Pi.authenticate(['payments', 'username'], onIncompletePayment);
                statusText.innerText = "ุฃููุงู ุจู: " + auth.user.username;
                statusText.style.color = "#4CAF50";
                paymentBox.style.display = "block"; // ุฅุธูุงุฑ ุตูุฏูู ุงูุฏูุน
            } catch (err) {
                console.error(err);
                statusText.innerText = "ูุฑุฌู ุงููุชุญ ูู ูุชุตูุญ Pi ููุท";
                statusText.style.color = "#f44336";
                // ุญุฑูุฉ ุฐููุฉ: ุฅุธูุงุฑ ุงูุฒุฑ ุญุชู ูู ูุดู ุงูุชุนุฑู ูุคูุชุงู ููุชุฌุฑุจุฉ
                paymentBox.style.display = "block";
            }
        }

        async function onIncompletePayment(payment) {
            console.log("ููุงู ุนูููุฉ ูุนููุฉ:", payment);
        }

        payBtn.onclick = async () => {
            statusText.innerText = "ุฌุงุฑู ุชุญุถูุฑ ุงูุฏูุน...";
            try {
                const payment = await Pi.createPayment({
                    amount: 2.6,
                    memo: "ุดุฑุงุก ููุชุฌ ุชุฌุฑูุจู - 2.6 Pi",
                    metadata: { orderId: "invoice_" + Date.now() }
                }, {
                    onReadyForServerApproval: async (id) => {
                        console.log("Server Approval for ID:", id);
                        const res = await fetch('/api/approve', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ paymentId: id })
                        });
                        return res.json();
                    },
                    onReadyForServerCompletion: async (id, txid) => {
                        console.log("Server Completion for ID:", id);
                        const res = await fetch('/api/complete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ paymentId: id, txid: txid })
                        });
                        return res.json();
                    },
                    onCancel: () => {
                        statusText.innerText = "ุชู ุฅูุบุงุก ุงูุฏูุน";
                        statusText.style.color = "#efa929";
                    },
                    onError: (err) => {
                        alert("ุญุฏุซ ุฎุทุฃ: " + err.message);
                        statusText.innerText = "ูุดู ุงูุฏูุน";
                    }
                });
            } catch (e) {
                console.error(e);
            }
        };

        // ุชุดุบูู ุงูููุฏ ููุฑ ุฌุงูุฒูุฉ ุงูุตูุญุฉ
        window.onload = initPi;
    </script>
</body>
</html>
